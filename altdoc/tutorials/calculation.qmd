---
title: "Seat allocation"
knitr: 
  opts_chunk: 
    dev: "ragg_png"
    fig.width: 7
    fig.height: 5
    dpi: 150
toc: true
---

```{r}
#| label: setup
#| message: false
library(PRcalc)
library(tidyverse)
```

## Import sample dataset

The first column contains the names of political parties, and the subsequent columns contain the respective number of votes for each party.

```{r}
#| label: dataset
# Korean general election in 2016
# See "str(kr_lower_2016_en)", for the full names of parties
# Number of blocks = 1 (national block)
data("kr_lower_2016_en")
kr_lower_2016_en

# Japanese lower house election in 2019 (in English)
# See "str(jp_lower_2021_en)", for the full names of parties
# Number of blocks = 11 (regional blocks)
data("jp_lower_2021_en")
jp_lower_2021_en
```

## Calculation

To calculate seat allocation using the `prcalc()` function, you need to specify the following: data (`x`), electoral magnitude (`m`), and allocation method (`method`). Below is an example of allocating 47 (`m = 47`) seats using the Hare-Niemeyer method (`method = "hn"`) with the `kr_lower_2016` dataset. In this case, the length of `m` is 1 because number of blocks is 1. Furthermore, by adjusting the `threshold` argument, it is possible to exclude parties with votes below a certain threshold from seat allocation. The follow is an example of threshold is 3% (0.03). Default is `threshold = 0`.

```{r}
#| label: calculation-1
# Example of national block (D'Hondt/Jefferson method)
obj1 <- prcalc(kr_lower_2016_en, m = 47, method = "hn", threshold = 0.03)
obj1
```

In a block system, you need to specify `m` for each block separately. Since `jp_lower_2021` has 11 blocks, the length of `m` also needs to be 11.

```{r}
#| label: calculation-2
# Example of regional block (D'Hondt/Jefferson method; 11 blocks)
obj2 <- prcalc(jp_lower_2021_en, 
               m = c(8, 13, 19, 22, 17, 11, 21, 28, 11, 6, 20), 
               method = "dt")
obj2
```

{PRcalc} offers various allocation methods. Below is an example similar to the previous one, but with the allocation methods changed to the Hare-Niemeyer (`"hn"`) method and the Sainte-Laguë method (`"sl"`).

```{r}
#| label: calculation-3
# Hare-Niemeyer method
obj3 <- prcalc(jp_lower_2021_en, 
               m = c(8, 13, 19, 22, 17, 11, 21, 28, 11, 6, 20), 
               method = "hn")
obj3

# Sainte-Laguë/Webster method
obj4 <- prcalc(jp_lower_2021_en, 
               m = c(8, 13, 19, 22, 17, 11, 21, 28, 11, 6, 20), 
               method = "sl")
obj4
```

Please [click here](../supplement/list_of_methods.qmd) for the list of various allocation methods provided by {PRcalc} and these abbreviations.

### Printing

`print()` and `summary()` functions are a method of `prcalc` object. You can hide a column of "Total" with `show_total = FALSE`.

```{r}
#| label: print-1
print(obj2, show_total = FALSE) # Hide `Total` column
```

In some cases, result is too long. You can adjust length of result using `head` argument. If `head = 10`, only ten rows are displayed. Default is `head = Inf`. (entire rows)

```{r}
#| label: print-2
print(obj2, head = 10) # Show only ten rows.
```

In default, numbers of votes and seats are displayed. If you switch to proportion using `prop = TRUE`.

```{r}
#| label: print-3
print(obj2, head = 5, prop = TRUE)
```

If `use_gt = TRUE`, a result rendered using {[gt](https://gt.rstudio.com/)} package. Furthermore, the `digits` argument allows specifying the number of decimal places for the output. Default is `digits = 3`.

```{r}
#| label: print-4
print(obj2, prop = TRUE, use_gt = TRUE, digits = 3)
```

`summary()` function is a useful when number of blocks is large. `summary()` function displays only the total column.

```{r}
#| label: print-5
summary(obj2) # summarize
```

`prop` argument is also allowed in `summary()` function.

```{r}
#| label: print-6
summary(obj2, prop = TRUE) # summarize with proportion
```

### Visualization

```{r}
#| label: plot
plot(obj1)
plot(obj2)
plot(obj2, angle = 90)
# Output only some parties
plot(obj2, 
     subset_p = c("LDP", "NKP", "CDP", "JIP", "JCP", "DPP"))
# Output only some district
plot(obj2, 
     subset_p = c("LDP", "NKP", "CDP", "JIP", "JCP", "DPP"),
     subset_b = c("Tokyo", "Kinki")) 
# Divide the facet by parties
plot(obj2, 
     subset_p = c("LDP", "NKP", "CDP", "JIP", "JCP", "DPP"),
     subset_b = c("Tokyo", "Kinki"),
     by        = "party")
# Three columns
plot(obj2, 
     subset_p = c("LDP", "NKP", "CDP", "JIP", "JCP", "DPP"),
     subset_b = c("Tokyo", "Kinki"),
     by        = "party",
     facet_col = 3)
# Use different y-axis scales for each facet
plot(obj2, 
     subset_p = c("LDP", "NKP", "CDP", "JIP", "JCP", "DPP"),
     subset_b  = c("Tokyo", "Kinki"),
     by        = "party",
     facet_col = 3,
     free_y    = TRUE)
```

## Comparison

You can compare multiple `prcalc` ojbects using `compare()` function. `prcalc` objects must be grouped in a list structure using `list()` function.

```{r}
#| label: compare-1
compare(list(obj2, obj3, obj4))
```

A named list structure is also available.

```{r}
#| label: compare-2
list("Jefferson"     = obj2, 
     "Hare-Niemeyer" = obj3, 
     "Webster"       = obj4) |> 
  compare() 
```

By using `print()` function with `subset` parameter, you can extract subset of the parties.

```{r}
#| label: compare-3
list("Jefferson"     = obj2, 
     "Hare-Niemeyer" = obj3, 
     "Webster"       = obj4) |> 
  compare() |> 
  print(subset = c("LDP", "NKP", "CDP", "JIP", "JCP", "DPP"))
```

If `prop = TRUE`, the proportion is displayed. It is also available to output tables in HTML format using `use_gt = TRUE`.

```{r}
#| label: compare-4
list("Jefferson"     = obj2, 
     "Hare-Niemeyer" = obj3, 
     "Webster"       = obj4) |> 
  compare() |> 
  print(prop = TRUE, use_gt = TRUE)
```

### Visualization

`plot()` function is a method of `prcalc_compare` class. Its return value is ggplot object.

```{r}
#| label: compare-visual-1
list("Jefferson"     = obj2, 
     "Hare-Niemeyer" = obj3, 
     "Webster"       = obj4) |> 
  compare() |> 
  plot()
```

If `facet = TRUE`, the plot is separated by parties.

```{r}
#| label: compare-visual-2
list("Jefferson"     = obj2, 
     "Hare-Niemeyer" = obj3, 
     "Webster"       = obj4) |> 
  compare() |> 
  plot(facet = TRUE)
```

If `facet = TRUE`, you can adjust number of columns and y-axis scale using `facet_col` and `free_y` parameters, respectively.

```{r}
#| label: compare-visual-3
list("Jefferson"     = obj2, 
     "Hare-Niemeyer" = obj3, 
     "Webster"       = obj4) |> 
  compare() |> 
  plot(subset_p = c("LDP", "NKP", "CDP", "JCP", "JIP", 
                    "DPP", "SDP", "Reiwa", "NHK"),
       facet = TRUE, facet_col = 3, free_y = FALSE)
```

## Customized allocation methods

Although {PRcalc} offers various allocation methods, it may not enough for your needs. In this case you can use fully customizable divisor (`"cd"`), quota (`"cq"`), and $\alpha$-divergence (`"ad"`).

### Custom divisor

```{r}
prcalc(kr_lower_2016_en, m = 47, method = "dt", threshold = 0.03)
prcalc(kr_lower_2016_en, m = 47, method = "cd", threshold = 0.03,
       extra = rep(1:16, each = 3))
```

### Custom quota

### $\alpha$-divergence
