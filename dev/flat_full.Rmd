---
title: "PRcalc"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
```

```{r description, eval=FALSE}
# Describe your package
fusen::fill_description(
  pkg = here::here(),
  fields = list(
    Title       = "A Proportional Representation Calculator",
    Description = "A Proportional Representation Calculator",
    `Authors@R` = c(person("Jaehyun", "Song", email = "song@kansai-u.ac.jp",
                           role = c("aut", "cre"))),
    Version     = "0.7.0",
    LazyData    = TRUE
  ),
  overwrite = TRUE
)
# Define License with use_*_license()
usethis::use_mit_license("Jaehyun Song")
```

`r if (knitr::is_html_output()) '<!--'` 

# 最大剰余法の計算

`r if (knitr::is_html_output()) '-->'`

```{r function-prcalc_lrm}
#' Largest Remainder Method
#'
#' @param votes a data.frame or tibble with two columns. The first and second column represents names of parties and numbers of votes, respectively.
#' @param seat a numeric value of number of seats.
#' @param method a character string giving a method for computing seat allocation. This must be one of the strings "hare", "droop", or "imperialiQ".
#' @param threshold an optional numeric value of threshold. The  
#' @param region_name a character string.
#' 
#' @importFrom dplyr mutate
#' @importFrom dplyr select
#' @importFrom dplyr case_when
#' @importFrom magrittr `%>%`
#'
#' @return
#' A data.frame with two columns.
#' @export
#'
#' @examples
prcalc_lrm <- function(votes, 
                       seat, 
                       method = c("hare", "droop", "imperialiQ"),
                       threshold = 0, 
                       region_name) {
  
  Seat <- Seat1 <- Seat2 <- Seat3 <- Seat4 <- Vote <- Vote2 <- Q <- Share <- NULL
  
  temp_votes        <- votes
  names(temp_votes) <- c("Party", "Vote")
  
  result <- temp_votes %>%
    mutate(
      Share = Vote / sum(Vote),
      Vote2 = ifelse(Share < threshold, NA, Vote),
      Total = sum(Vote2, na.rm = TRUE),
      Q     = case_when(method == "hare" ~ Total / seat,
                        method == "droop" ~ floor(1 + (Total / (1 + seat))),
                        method == "imperialiQ" ~ Total / (2 + seat)),
      Seat1 = floor(Vote2 / Q),
      Seat2 = 1 - ((Vote2 / Q) - floor(Vote2 / Q)),
      Seat3 = rank(Seat2),
      Seat4 = ifelse(Seat3 <= (seat - sum(Seat1, na.rm = TRUE)), 1, 0),
      Seat  = Seat1 + Seat4
    ) %>%
    select(Vote, Seat) %>%
    mutate(Seat = ifelse(is.na(Seat), 0, Seat))
  
  names(result) <- c(paste0(region_name, ":Vote"),
                     paste0(region_name, ":Seat"))
  
  result
}
```

```{r examples-prcalc_lrm, include = FALSE}
lrm_example <- data.frame(Party = c("Party A", "Party B", "Party C", "Party D"),
                          Votes = c(53000, 25000, 16600, 5400))

lrm_example

prcalc_lrm(votes       = lrm_example,
           seat        = 10,
           method      = "hare",
           threshold   = 0,
           region_name = "National")
```

`r if (knitr::is_html_output()) '<!--'` 

# 最高平均法の計算

`r if (knitr::is_html_output()) '-->'`

```{r function-prcalc_hae}
#' Highest Average
#'
#' @param votes a data.frame or tibble with two columns. The first and second column represents names of parties and numbers of votes, respectively.
#' @param seat a numeric value of number of seats.
#' @param method a character string giving a method for computing seat allocation. This must be one of the strings "dt", "sl", "msl", "adams", "danish", "hh", "dean", or "imperiali".
#' @param threshold an optional numeric value of threshold. The  
#' @param region_name a character string.
#' 
#' @importFrom dplyr mutate
#' @importFrom dplyr select
#' @importFrom dplyr arrange
#' @importFrom dplyr desc
#' @importFrom dplyr group_by
#' @importFrom dplyr left_join
#' @importFrom dplyr summarise
#' @importFrom dplyr n
#' @importFrom dplyr case_when
#' @importFrom magrittr `%>%`
#' @importFrom utils head
#'
#' @return
#' A data.frame with two columns.
#' @export
#'
#' @examples
prcalc_hae <- function(votes, 
                       seat, 
                       method      = c("dt", "sl", "msl", "adams", "danish", "hh", "dean", "imperiali"), 
                       threshold   = 0, 
                       region_name = "National") {
  
  Seat <- Vote <- Party <- Q <- Share <- NULL
  
  temp_votes        <- votes
  raw_votes         <- votes
  names(temp_votes) <- c("Party", "Vote")
  names(raw_votes)  <- c("Party", "Vote")
  
  temp_votes <- temp_votes %>%
    mutate(Share = Vote / sum(Vote),
           Vote  = ifelse(Share < threshold, 0, Vote))
  
  temp_votes <- temp_votes[rep(1:nrow(temp_votes), seat), ]
  
  R_n <- 0:(seat - 1)
  
  if (method == "dt") {
    # D'Hondt method
    R_n_vec <- R_n + 1
  } else if (method == "sl") {
    # Sainte-Laguë method
    R_n_vec <- seq(1, by = 2, length.out = seat)
  } else if (method == "msl") {
    # Modified Sainte-Laguë method
    R_n_vec <- seq(1, by = 2, length.out = seat)
    R_n_vec[1] <- 1.4
  } else if (method == "adams") {
    # Adams's method
    R_n_vec <- R_n
  } else if (method == "danish") {
    # Danish method
    R_n_vec <- seq(1, 3 * seat, by = 3)
  } else if (method == "hh") {
    # Huntington–Hill method
    R_n_vec <- sqrt(R_n * (R_n + 1))
  } else if (method == "dean") {
    # Dean method
    R_n_vec <- (2 * R_n * (R_n + 1)) / (2 * R_n + 1)
  } else if (method == "imperiali") {
    # Imperiali
    R_n_vec <- seq(1, by = 0.5, length.out = seat)
  }
  
  seat_df <- temp_votes %>% 
    mutate(R_n = rep(R_n_vec, each = nrow(votes)),
           Q   = Vote / R_n) %>%
    arrange(desc(Q)) %>%
    head(n = seat) %>%
    group_by(Party) %>%
    summarise(Seat    = n(),
              .groups = "drop") %>%
    as.data.frame()
  
  hae_result <- left_join(raw_votes, seat_df, by = "Party") %>%
    select(-Party) %>%
    mutate(Seat = ifelse(is.na(Seat), 0, Seat))
  
  names(hae_result) <- c(paste0(region_name, ":Vote"),
                         paste0(region_name, ":Seat"))
  
  hae_result
}
```

```{r examples-prcalc_hae, include = FALSE}
hae_example <- data.frame(Party = c("Party A", "Party B", "Party C", "Party D"),
                          Votes = c(53000, 25000, 16600, 5400))

hae_example

prcalc_hae(votes       = hae_example,
           seat        = 10,
           method      = "dt",
           threshold   = 0,
           region_name = "National")
```

`r if (knitr::is_html_output()) '<!--'` 

# ブロック制

`r if (knitr::is_html_output()) '-->'`

```{r function-prcalc_block}
#' Block PR
#'
#' @param votes a data.frame or tibble with two columns. The first and second column represents names of parties and numbers of votes, respectively.
#' @param seat a numeric value of number of seats.
#' @param method a character string giving a method for computing seat allocation. This must be one of the strings "dt", "sl", "msl", "adams", "danish", "hh", "dean", or "imperiali".
#' @param threshold an optional numeric value of threshold. The  
#' 
#' @importFrom dplyr select
#' @importFrom dplyr bind_cols
#' @importFrom dplyr ends_with
#'
#' @return
#' A data.frame with two columns.
#' @export
#'
#' @examples
prcalc_block <- function(votes, 
                         seat, 
                         method, 
                         threshold = 0) {
  
  Party <- NULL
  
  multi_result <- list()
  region_list  <- names(votes)[-1]
  
  LRM_methods <- c("hare", "droop", "imperialiQ")
  HAE_methods <- c("dt", "sl", "msl", "adams", "danish",
                   "hh", "dean", "imperiali")
  
  if (method %in% LRM_methods) {
    for (i in 1:length(region_list)) {
      temp_df <- votes[, c(1, i+1)]
      multi_result[[i]] <- prcalc_lrm(temp_df, seat[i], method, 
                                      threshold, region_list[i])
    }
  } else if (method %in% HAE_methods) {
    for (i in 1:length(region_list)) {
      temp_df <- votes[, c(1, i+1)]
      multi_result[[i]] <- prcalc_hae(temp_df, seat[i], method, 
                                      threshold, region_list[i])
    }
  }
  
  multi_result <- bind_cols(data.frame(Party = votes[, 1]),
                            bind_cols(multi_result))
  
  multi_result1 <- select(multi_result, Party, ends_with("Vote"))
  multi_result2 <- select(multi_result, Party, ends_with("Seat"))
  
  multi_result <- list(Vote = multi_result1, Seat = multi_result2)
  
  multi_result
}
```

```{r examples-prcalc_block, include = FALSE}
block_example <- data.frame(Party    = c("Party A", "Party B", "Party C", "Party D"),
                            Region_A = c(53000, 25000, 16600, 5400),
                            Region_B = c(12000, 34000, 5000, 10000),
                            Region_C = c(40000, 30000, 20000, 9000))

block_example

prcalc_block(votes       = block_example,
             seat        = c(10, 8, 11),
             method      = "dt",
             threshold   = 0)
```

# 比例代表の議席割当計算

```{r function-PRcalc}
#' PR Calculation
#'
#' @param x a \code{data.frame} or \code{tibble} object. 
#' @param seats 長さ1以上の\code{numeric}型ベクトル
#' @param method a string
#' @param threshold a numeric value
#' 
#' @importFrom dplyr case_when
#' @importFrom purrr map_df
#' @importFrom stringr str_replace
#'
#' @return
#' A \code{list} type object.
#' @export
#'
#' @examples
PRcalc <- function (x, 
                    seats, 
                    method, 
                    threshold = 0) {
  
  seat_vec <- seats
  temp_df  <- x
  
  PRcalc_Result <- prcalc_block(votes = temp_df, seat = seat_vec,
                                method = method, threshold = threshold)
  
  VS_df <- PRcalc_Result$Vote
  SS_df <- PRcalc_Result$Seat
  
  if (ncol(VS_df) > 2 & ncol(SS_df) > 2) {
    PRcalc_Result$Vote$Total <- rowSums(PRcalc_Result$Vote[, -1])
    PRcalc_Result$Seat$Total <- rowSums(PRcalc_Result$Seat[, -1])
    VS_df$Total <- rowSums(VS_df[, -1])
    SS_df$Total <- rowSums(SS_df[, -1])  
  }
  
  if (ncol(VS_df) == 2 & ncol(SS_df) == 2) {
    VS_df[, -1] <- VS_df[, -1] / sum(VS_df[, -1]) * 100
    SS_df[, -1] <- SS_df[, -1] / sum(SS_df[, -1]) * 100
  } else if (ncol(VS_df) > 2 & ncol(SS_df) > 2) {
    VS_df[, -1] <- as.data.frame(map_df(VS_df[, -1], ~(.x / sum(.x) * 100)))
    SS_df[, -1] <- as.data.frame(map_df(SS_df[, -1], ~(.x / sum(.x) * 100)))
  }
  
  names(PRcalc_Result$Vote) <- str_replace(names(PRcalc_Result$Vote), ":Vote", "")
  names(PRcalc_Result$Seat) <- str_replace(names(PRcalc_Result$Seat), ":Seat", "")
  names(VS_df) <- str_replace(names(VS_df), ":Vote", "")
  names(SS_df) <- str_replace(names(SS_df), ":Seat", "")
  
  Method_full_name <- case_when(method == "hare" ~ "Hare\u2013Niemeyer",
                                method == "droop" ~ "Droop",
                                method == "imperialiQ" ~ "Imperiali Quota",
                                method == "dt" ~ "D\'Hondt (Jefferson)",
                                method == "sl" ~ "Sainte\u2013Lagu\u00eb (Webster)",
                                method == "msl" ~ "Modified Sainte\u2013Lagu\u00eb",
                                method == "hh" ~ "Huntington\u2013Hill",
                                method == "danish" ~ "Danish",
                                method == "adams" ~ "Adams\'s",
                                method == "imperiali" ~ "Imperiali",
                                method == "dean" ~ "Dean")
  
  PRcalc_Result <- list(Vote = PRcalc_Result$Vote,
                        Seat = PRcalc_Result$Seat,
                        VoteShare = VS_df,
                        SeatShare = SS_df,
                        N_Seat    = c(seats, sum(seats)),
                        N_Block   = length(seats),
                        threshold = threshold,
                        Method    = Method_full_name)
  
  class(PRcalc_Result) <- c("PRcalc", "list")
  
  return(structure(PRcalc_Result, class = c("PRcalc", "list")))
}
```

```{r function-print}
#' Print \code{PRclac} Object
#'
#' @method print PRcalc
#'
#' @param x \code{PRcalc} object
#' @param prop a logical value
#' @param digits a integer
#' @param ... Ingnored
#' 
#' @importFrom dplyr left_join
#' @importFrom dplyr mutate
#' @importFrom dplyr across
#'
#' @return
#' A data.frame
#' 
#' @export
#'
#' @examples
print.PRcalc <- function (x, prop = FALSE, digits = 3, ...) {
  
  Party <- NULL
  
  if (prop == FALSE) {
    result <- left_join(x$Vote, x$Seat, by = "Party",
                        suffix = c("_V", "_S"))
  } else if (prop == TRUE) {
    temp_vote <- mutate(x$VoteShare, 
                        across(.cols = -Party, 
                               ~sprintf(paste0("%.", digits, "f"), .x)))
    temp_seat <- mutate(x$SeatShare, 
                        across(.cols = -Party, 
                               ~sprintf(paste0("%.", digits, "f"), .x)))
    result <- left_join(temp_vote, temp_seat, by = "Party",
                        suffix = c("_V", "_S"))
  }
  
  print(result)
}
```

```{r function-summary}
#' Summarise \code{PRclac} Object
#'
#' @method summary PRcalc
#'
#' @param object \code{PRcalc} object
#' @param prop a logical value
#' @param digits a integer
#' @param ... Ingnored
#' 
#' @importFrom dplyr left_join
#' @importFrom dplyr mutate
#' @importFrom dplyr last_col
#' @importFrom dplyr across
#'
#' @return
#' A data.frame
#' 
#' @export
#'
#' @examples
summary.PRcalc <- function (object, prop = FALSE, digits = 3, ...) {
  
  result <- vote <- seat <- NULL
  
  if (prop == FALSE) {
    vote <- select(object$Vote, 1, Total_Vote = last_col())
    seat <- select(object$Seat, 1, Total_Seat = last_col())
    
    result <- left_join(vote, seat, by = "Party")
  } else if (prop == TRUE) {
    vote <- select(object$VoteShare, 1, Total_Vote = last_col())
    seat <- select(object$SeatShare, 1, Total_Seat = last_col())

    result <- left_join(vote, seat, by = "Party")
    
    result <- mutate(result, 
                     across(.cols = -1, 
                            ~sprintf(paste0("%.", digits, "f"), .x)))
  }
  
  print(result)
}
```

## 例1) 全国区 & 5つの政党

* 議席数8 (`seats = 8`)、修正サン＝ラゲ方式 (`method = "msl"`)、阻止条項なし (`threshold = 0`)

| 政党名  | 得票数 |
|:-------:|-------:|
| Party A | 778000 |
| Party B | 714000 |
| Party C | 331000 |
| Party D | 229000 |
| Party E | 230000 |

```{r examples-PRcalc-1}
Election_Data1 <- data.frame(Party = c("Party A", "Party B", "Party C",
                                       "Party D", "Party E"),
                             Votes = c(778000, 714000, 331000, 299000, 230000))

Election_Data1

# 議席数8、修正サン＝ラゲ方式、阻止条項なし
PR_example1 <- PRcalc(Election_Data1, seats = 8, method = "msl", threshold = 0)

PR_example1
```

## 例2) 全国区 & 5つの政党 & 阻止条項10%

* `Election_Data1`と同じ設定 + 阻止条項10% (`threshold = 0.1`)

```{r examples-PRcalc-2}
# 議席数8、修正サン＝ラゲ方式、阻止条項15%
PR_example2 <- PRcalc(Election_Data1, seats = 8, method = "msl", threshold = 0.1)

PR_example2
```

## 例3) ブロック制 & 5つの政党

* 議席数8、13 (`seats = c(8, 13)`)、ドント方式 (`method = "dt"`)、阻止条項なし (`threshold = 0`)

| 政党名  | ブロック1の得票数 | ブロック2の得票数 |
|:-------:|------------------:|------------------:|
| Party A | 778000            | 1454000           |
| Party B | 714000            | 761000            |
| Party C | 331000            | 913000            |
| Party D | 229000            | 464000            |
| Party E | 230000            | 311000            |

```{r examples-PRcalc-3}
Election_Data3 <- data.frame(Party   = c("Party A", "Party B", "Party C",
                                         "Party D", "Party E"),
                             Region1 = c(778000, 714000, 331000, 299000, 230000),
                             Region2 = c(1454000, 761000, 913000, 464000, 311000))

Election_Data3

PR_example3 <- PRcalc(Election_Data3, seats = c(8, 13), method = "dt", threshold = 0)

PR_example3
```

```{r examples-PRcalc-4}
# 得票「率」と議席「率」を示す場合
print(PR_example3, prop = TRUE)
```

```{r examples-PRcalc-5}
# 小数点の桁数を調整する場合
print(PR_example3, prop = TRUE, digits = 1)
```

`summary()`関数を使用するとブロックごとの得票数 (率)、議席数 (率)が省略されます。使い方は`print()`と同じです。

```{r examples-PRcalc-6}
summary(PR_example3)
summary(PR_example3, prop = TRUE, digits = 2)
```


# 各種指標の計算

```{r function-index-generic}
#' \code{index}ジェネリック関数
#' 
#' @param x \code{PRcalc}オブジェクト
#' @param ... Ignored
#'
#' @return
#' none
#' @export
#'
#' @examples
index <- function(x, ...) {
  UseMethod("index")
}
```

```{r function-index}
#' 各種指標の計算
#' 
#' @param x \code{PRcalc}オブジェクト
#' @param ... Ignored
#'
#' @importFrom dplyr select
#' @importFrom dplyr pull
#' @importFrom dplyr last_col
#'
#' @return
#' A \code{PRcalc_index} object.
#' @export
#'
#' @reference
#' Laakso, Markku and Rein Taagepera. 1979. ""Effective" Number of Parties: A Measure with Application to West Europe". Comparative Political Studies. 12 (1): 3–27.
#' Gallagher, Michael. 1991. "Proportionality, Disproportionality and Electoral Systems". Electoral Studies. 10: 33–51.
#'
#' @examples
index.PRcalc <- function (x, ...) {
  
  Vote <- NULL
  
  Index_list <- NULL
  Index_list <- list()
  
  vote <- pull(select(x$VoteShare, Vote = last_col()), Vote)
  seat <- pull(select(x$SeatShare, Vote = last_col()), Vote)
  
  VS_df <- Rae_V <- Dhondt_V <- vote
  SS_df <- Rae_S <- Dhondt_S <- seat
  
  Rae_V[Rae_V < 0.5] <- NA
  Rae_S[Rae_S < 0.5] <- NA
  
  Dhondt_V[Dhondt_V < 0.5] <- NA
  Dhondt_S[Dhondt_S < 0.5] <- NA
  
  Index_list[["enp_vote"]]  <- 1 / sum((vote / 100)^2) # ENP (Vote)
  Index_list[["enp_seat"]]  <- 1 / sum((seat / 100)^2) # ENP (Seat)
  Index_list[["gallagher"]] <- sqrt(0.5 * sum((vote - seat)^2)) # Gallagher
  Index_list[["rose"]]      <- sum(abs(vote - seat)) * 0.5                # Rose
  Index_list[["rae"]]       <- mean(abs(Rae_V - Rae_S), na.rm = TRUE)     # Rae 
  Index_list[["sl"]]        <- sum((vote - seat)^2 / vote, na.rm  = TRUE) # SL
  Index_list[["dt"]]        <- max(seat / vote, na.rm = TRUE) # Dhondt
  Index_list[["dt5"]]       <- max(Dhondt_S / Dhondt_V, na.rm = TRUE) # Dhondt5
  
  class(Index_list) <- c("PRcalc_index", "list")
  
  Index_list
}
```

```{r function-print-2}
#' Print \code{PRcalc_index} Object
#'
#' @method print PRcalc_index
#'
#' @param x A \code{PRcalc_index} object
#' @param digits a integer
#' @param ... Ingnored
#'
#' @return
#' none
#' 
#' @export
#'
#' @examples
print.PRcalc_index <- function (x, digits = 3, ...) {
  
  result <- data.frame(
    Index = c("ENP (Vote)", "ENP (Seat)", "Gallagher", "Loosemore\u2013Hanby",
              "Rae", "Sainte\u2013Lagu\u00eb", "D\'Hondt", "D\'Hondt (5%)"),
    Value = sprintf(paste0("%.", digits, "f"), unlist(x))
  )
  
  print(result)
}
```

```{r examples-index}
Election_Data1 <- data.frame(Party = c("Party A", "Party B", "Party C",
                                       "Party D", "Party E"),
                             Votes = c(778000, 714000, 331000, 299000, 230000))
Election_Data2 <- data.frame(Party   = c("Party A", "Party B", "Party C",
                                         "Party D", "Party E"),
                             Region1 = c(778000, 714000, 331000, 299000, 230000),
                             Region2 = c(1454000, 761000, 913000, 464000, 311000))

PR_example1 <- PRcalc(Election_Data1, seats = 8, method = "msl", threshold = 0)
PR_example2 <- PRcalc(Election_Data1, seats = 8, method = "msl", threshold = 0.1)
PR_example3 <- PRcalc(Election_Data2, seats = c(8, 13), method = "dt", threshold = 0)

PR_index1 <- index(PR_example1)
PR_index2 <- index(PR_example2)
PR_index3 <- index(PR_example3)

PR_index1
print(PR_index2, digits = 1)
PR_index3$gallagher # Gallagher非比例性指標のみ抽出
```

# 比較

```{r function-comapre-generic}
#' \code{compare}ジェネリック関数
#' 
#' @param x \code{PRcalc}オブジェクト
#' @param ... Ignored
#'
#' @return
#' none
#' @export
#'
#' @examples
compare <- function(x, ...) {
  UseMethod("compare", x)
}
```

```{r function-compare}
#' \code{PRcalc}オブジェクトの比較
#' 
#' @param x \code{PRcalc}オブジェクト
#' @param y \code{PRcalc}オブジェクト
#' @param type 比較の基準; \code{"seat"} (議席数; 既定値)、または\code{"index"} (各種指標)
#' @param ... Ignored
#'
#' @return
#' A \code{PRcalc_compare} object
#' @export
#'
#' @examples
compare.PRcalc <- function(x, 
                           y, 
                           type   = "seat", 
                           ...) {
  party <- x$Vote[, 1]
  vote1 <- x$Vote[, ncol(y$Vote)]
  vote2 <- y$Vote[, ncol(x$Vote)]
  seat1 <- x$Seat[, ncol(x$Seat)]
  seat2 <- y$Seat[, ncol(y$Seat)]
  
  if (all(vote1 != vote2)) {
    stop("Total votes of x are incompatible with that of y.")
  }
  
  if (type == "seat") {
    result <- data.frame(Party   = party,
                         Votes   = vote1,
                         Method1 = seat1,
                         Method2 = seat2)
    
    result$Diff <- result$Method2 - result$Method1
    
    rownames(result) <- NULL

    result_list <- list(result     = result,
                        method1    = x$Method,
                        method2    = y$Method,
                        threshold1 = x$threshold,
                        threshold2 = y$threshold,
                        seat1      = sum(x$N_Seat[-1]),
                        seat2      = sum(y$N_Seat[-1]),
                        type       = "seat")
  } else if (type == "index") {
    result <- data.frame(Index = c(c("ENP (Vote)", "ENP (Seat)", "Gallagher",
                                     "Loosemore\u2013Hanby", "Rae",
                                     "Sainte\u2013Lagu\u00eb", "D\'Hondt",
                                     "D\'Hondt (5%)")),
                         Method1 = unlist(index(x)),
                         Method2 = unlist(index(y)))
    
    result$Diff    <- result$Method2 - result$Method1

    rownames(result) <- NULL
    
    result_list <- list(result     = result,
                        method1    = x$Method,
                        method2    = y$Method,
                        threshold1 = x$threshold,
                        threshold2 = y$threshold,
                        seat1      = sum(x$N_Seat[-1]),
                        seat2      = sum(y$N_Seat[-1]),
                        type       = "index")
  } else {
    stop('"type" must be "seat" or "index".')
  }
  
  return(structure(result_list, class = c("PRcalc_compare", "list")))
}
```

```{r function-print-PRcalc_compare}
#' \code{PRcalc}オブジェクトの比較
#' 
#' @param x \code{PRcalc_compare}オブジェクト
#' @param digits 小数点の表示桁数
#' @param ... Ignored
#'
#' @return
#' A \code{PRcalc_compare} object
#' @export
#'
#' @examples
print.PRcalc_compare <- function(x, digits = 3, ...) {
  result <- x[["result"]]
  
  if (x$type == "index") {
    result$Method1 <- sprintf(paste0("%.", digits, "f"), unlist(result$Method1))
    result$Method2 <- sprintf(paste0("%.", digits, "f"), unlist(result$Method2))
    result$Diff    <- sprintf(paste0("%.", digits, "f"), unlist(result$Diff))
  }
  
  print(result)
  cat("Information \n",
      "# Method1:", x$method1, 
      "(Number of seats = ", x$seat1, 
      "/ threshold: ", x$threshold1, ")\n",
      "# Method2:", x$method2, 
      "(Number of seats = ", x$seat2,
      "/ threshold: ", x$threshold2, ")\n",
      "# Diff   : Method2 - Method1")  
}
```

```{r examples-compare-1}
# アラバマのパラドックス
Election_Data3 <- data.frame(Party = c("Party A", "Party B", "Party C"),
                             Votes = c(5665, 3685, 1650))

PR_example3 <- PRcalc(Election_Data3, seats = 10, method = "hare")
PR_example4 <- PRcalc(Election_Data3, seats = 11, method = "hare")

compare(PR_example3, PR_example4)
```

```{r examples-compare-2}
# 議席割当方式の比較
PR_example5 <- PRcalc(Election_Data3, seats = 10, method = "dt")

compare(PR_example3, PR_example5)
```

```{r examples-compare-3}
compare1 <- compare(PR_example3, PR_example4, type = "index")
compare1
```

```{r examples-compare-4}
compare2 <- compare(PR_example3, PR_example5, type = "index")
print(compare2, digits = 1)
```

# 可視化

```{r function-plot}
#' \code{PRcalc}オブジェクトの可視化
#'
#' @method plot PRcalc
#' 
#' @param x \code{PRcalc}オブジェクト
#' @param summary \code{TRUE}、または\code{FALSE} (既定値); \code{TRUE}の場合、ブロックごとのプロットが省略されます。
#' @param xlab 横軸のタイトル
#' @param ylab 縦軸のタイトル
#' @param vs_lab 凡例ラベル (得票率)
#' @param ss_lab 凡例ラベル (議席率)
#' @param text_size 文字の大きさ; 既定値は12
#' @param text_angle 横軸ラベルの角度; 既定値は0
#' @param ... Ingnored
#' 
#' @importFrom dplyr left_join
#' @importFrom dplyr mutate
#' @importFrom dplyr case_when
#' @importFrom tidyr separate
#' @importFrom tidyr pivot_longer
#' @importFrom ggplot2 ggplot
#' @importFrom ggplot2 geom_bar
#' @importFrom ggplot2 aes
#' @importFrom ggplot2 position_dodge
#' @importFrom ggplot2 labs
#' @importFrom ggplot2 facet_wrap
#' @importFrom ggplot2 theme_bw
#' @importFrom ggplot2 theme
#' @importFrom ggplot2 element_text
#' @importFrom forcats fct_inorder
#' @importFrom magrittr `%>%`
#'
#' @return
#' A \code{ggplot} object.
#' @export
#'
#' @examples
plot.PRcalc <- function (x, 
                         summary    = FALSE, 
                         xlab       = "Party",
                         ylab       = "%",
                         vs_lab     = "Vote share",
                         ss_lab     = "Seat share",
                         text_size  = 12,
                         text_angle = 0, 
                         ...) {
  
  Party <- Type <- Share <- Region <- NULL
  vote <- seat <- temp_df <- NULL
  text_hjust <- text_vjust <- NULL
  
  text_hjust <- case_when(text_angle == 0  ~ 0.5,
                          text_angle == 90 ~ 1,
                          TRUE             ~ 1)
  
  text_vjust <- case_when(text_angle == 0  ~ 1,
                          text_angle == 90 ~ 0.5,
                          TRUE             ~ 1)
  
  if (summary | x$N_Block == 1) {
    vote <- select(x$VoteShare, 1, TV = last_col())
    seat <- select(x$SeatShare, 1, TS = last_col())
    
    temp_df <- left_join(vote, seat, by = "Party") %>%
      pivot_longer(cols      = -Party,
                   names_to  = "Type",
                   values_to = "Share") %>%
      mutate(Type  = factor(Type, levels = c("TV", "TS"), 
                            labels = c(vs_lab, ss_lab)),
             Share = Share)
  } else {
    temp_df <- left_join(x$VoteShare, x$SeatShare, by = "Party",
                         suffix = c("_V", "_S")) %>%
      pivot_longer(cols      = -Party,
                   names_to  = "Region",
                   values_to = "Share") %>%
      separate(Region, into = c("Region", "Type"), sep = "_") %>%
      mutate(Region = fct_inorder(Region)) %>%
      mutate(Type  = factor(Type, levels = c("V", "S"), 
                            labels = c(vs_lab, ss_lab)),
             Share = Share) 
  }
  
  result_plot <- temp_df %>%
    mutate(Party = fct_inorder(Party)) %>%
    ggplot() +
    geom_bar(aes(x = Party, y = Share, fill = Type), 
             stat = "identity", position = position_dodge()) +
    labs(x = xlab, y = ylab, fill = "") +
    theme_bw(base_size = 12) +
    theme(legend.position = "bottom",
          axis.text.x     = element_text(angle = text_angle, 
                                         hjust = text_hjust,
                                         vjust = text_vjust),
          text            = element_text(size  = text_size))
  
  if (summary | x$N_Block == 1) {
    return(result_plot)
  } else{
    return(result_plot + facet_wrap(~Region))
  }
}
```

可視化の場合、得票**率**と議席**率**が表示されます。

```{r examples-plot-1}
#| dev: "ragg_png"
#| fig.width: 7
#| out.width: 650
#| dpi: 300
Election_Data1 <- data.frame(Party = c("Party A", "Party B", "Party C",
                                       "Party D", "Party E"),
                             Votes = c(778000, 714000, 331000, 299000, 230000))

PR_example1 <- PRcalc(Election_Data1, seats = 8, method = "msl", threshold = 0)

plot(PR_example1) # PR_example1の可視化
```

```{r examples-plot-2}
#| dev: "ragg_png"
#| fig.width: 7
#| out.width: 650
#| dpi: 300
Election_Data2 <- data.frame(Party   = c("Party A", "Party B", "Party C",
                                         "Party D", "Party E"),
                             Region1 = c(778000, 714000, 331000, 299000, 230000),
                             Region2 = c(1454000, 761000, 913000, 464000, 311000))

PR_example2 <- PRcalc(Election_Data2, seats = c(8, 13), method = "dt", threshold = 0)

plot(PR_example2) # PR_example2の可視化
plot(PR_example2, text_angle = 25) # X軸ラベルの回転
plot(PR_example2, summary = TRUE) # ブロックごとの図を省略
```

# サンプルデータ

```{r function-jp_census_1920}
#' 都道府県別人口 (1920年)
#'
#' 47都道府県の人口
#'
#' @format A data frame with 47 rows and 2 variables:
#' \describe{
#'   \item{ Pref }{ 都道府県名; character }
#'   \item{ Pop }{ 人口; numeric }
#' }
#' 
#' @usage data(jp_census_1920)
#' 
#' @source 国勢調査
"jp_census_1920"
```

```{r function-jp_census_1945}
#' 都道府県別人口 (1945年)
#'
#' 47都道府県の人口 (1945年)
#'
#' @format A data frame with 47 rows and 2 variables:
#' \describe{
#'   \item{ Pref }{ 都道府県名; character }
#'   \item{ Pop }{ 人口; numeric }
#' }
#' 
#' @usage data(jp_census_1945)
#' 
#' @source 国勢調査
"jp_census_1945"
```

```{r function-jp_census_1970}
#' 都道府県別人口 (1970年)
#'
#' 47都道府県の人口 (1970年)
#'
#' @format A data frame with 47 rows and 2 variables:
#' \describe{
#'   \item{ Pref }{ 都道府県名; character }
#'   \item{ Pop }{ 人口; numeric }
#' }
#' 
#' @usage data(jp_census_1970)
#' 
#' @source 国勢調査
"jp_census_1970"
```

```{r function-jp_census_2015}
#' 都道府県別人口 (2015年)
#'
#' 47都道府県の人口 (2015年)
#'
#' @format A data frame with 47 rows and 2 variables:
#' \describe{
#'   \item{ Pref }{ 都道府県名; character }
#'   \item{ Pop }{ 人口; numeric }
#' }
#' 
#' @usage data(jp_census_2015)
#' 
#' @source 国勢調査
"jp_census_2015"
```

```{r function-jp_lower_2009}
#' 衆議院議員総選挙比例区得票数 (2009年)
#'
#' 衆議院議員総選挙比例区の得票数 (2009年)
#'
#' @format A data frame with 47 rows and 12 variables:
#' \describe{
#'   \item{ Party }{ 政党名; character }
#'   \item{ Hokkaido }{ 北海道ブロックの得票数; numeric }
#'   \item{ Tohoku }{ 東北ブロックの得票数; numeric }
#'   \item{ Kitakanto }{ 北関東ブロックの得票数; numeric }
#'   \item{ Minamikanto }{ 南関東ブロックの得票数; numeric }
#'   \item{ Tokyo }{ 東京ブロックの得票数; numeric }
#'   \item{ Hokuriku }{ 北陸信越ブロックの得票数; numeric }
#'   \item{ Tokai }{ 東海ブロックの得票数; numeric }
#'   \item{ Kinki }{ 近畿ブロックの得票数; numeric }
#'   \item{ Chugoku }{ 中国ブロックの得票数; numeric }
#'   \item{ Shikoku }{ 四国ブロックの得票数; numeric }
#'   \item{ Kyushu }{ 九州ブロックの得票数; numeric }
#' }
#' 
#' @usage data(jp_lower_2009)
#' 
#' @source 総務省
"jp_lower_2009"
```

```{r function-jp_lower_2012}
#' 衆議院議員総選挙比例区得票数 (2012年)
#'
#' 衆議院議員総選挙比例区の得票数 (2012年)
#'
#' @format A data frame with 47 rows and 12 variables:
#' \describe{
#'   \item{ Party }{ 政党名; character }
#'   \item{ Hokkaido }{ 北海道ブロックの得票数; numeric }
#'   \item{ Tohoku }{ 東北ブロックの得票数; numeric }
#'   \item{ Kitakanto }{ 北関東ブロックの得票数; numeric }
#'   \item{ Minamikanto }{ 南関東ブロックの得票数; numeric }
#'   \item{ Tokyo }{ 東京ブロックの得票数; numeric }
#'   \item{ Hokuriku }{ 北陸信越ブロックの得票数; numeric }
#'   \item{ Tokai }{ 東海ブロックの得票数; numeric }
#'   \item{ Kinki }{ 近畿ブロックの得票数; numeric }
#'   \item{ Chugoku }{ 中国ブロックの得票数; numeric }
#'   \item{ Shikoku }{ 四国ブロックの得票数; numeric }
#'   \item{ Kyushu }{ 九州ブロックの得票数; numeric }
#' }
#' 
#' @usage data(jp_lower_2012)
#' 
#' @source 総務省
"jp_lower_2012"
```

```{r function-jp_lower_2014}
#' 衆議院議員総選挙比例区得票数 (2014年)
#'
#' 衆議院議員総選挙比例区の得票数 (2014年)
#'
#' @format A data frame with 47 rows and 12 variables:
#' \describe{
#'   \item{ Party }{ 政党名; character }
#'   \item{ Hokkaido }{ 北海道ブロックの得票数; numeric }
#'   \item{ Tohoku }{ 東北ブロックの得票数; numeric }
#'   \item{ Kitakanto }{ 北関東ブロックの得票数; numeric }
#'   \item{ Minamikanto }{ 南関東ブロックの得票数; numeric }
#'   \item{ Tokyo }{ 東京ブロックの得票数; numeric }
#'   \item{ Hokuriku }{ 北陸信越ブロックの得票数; numeric }
#'   \item{ Tokai }{ 東海ブロックの得票数; numeric }
#'   \item{ Kinki }{ 近畿ブロックの得票数; numeric }
#'   \item{ Chugoku }{ 中国ブロックの得票数; numeric }
#'   \item{ Shikoku }{ 四国ブロックの得票数; numeric }
#'   \item{ Kyushu }{ 九州ブロックの得票数; numeric }
#' }
#' 
#' @usage data(jp_lower_2014)
#' 
#' @source 総務省
"jp_lower_2014"
```

```{r function-jp_lower_2017}
#' 衆議院議員総選挙比例区得票数 (2017年)
#'
#' 衆議院議員総選挙比例区の得票数 (2017年)
#'
#' @format A data frame with 47 rows and 12 variables:
#' \describe{
#'   \item{ Party }{ 政党名; character }
#'   \item{ Hokkaido }{ 北海道ブロックの得票数; numeric }
#'   \item{ Tohoku }{ 東北ブロックの得票数; numeric }
#'   \item{ Kitakanto }{ 北関東ブロックの得票数; numeric }
#'   \item{ Minamikanto }{ 南関東ブロックの得票数; numeric }
#'   \item{ Tokyo }{ 東京ブロックの得票数; numeric }
#'   \item{ Hokuriku }{ 北陸信越ブロックの得票数; numeric }
#'   \item{ Tokai }{ 東海ブロックの得票数; numeric }
#'   \item{ Kinki }{ 近畿ブロックの得票数; numeric }
#'   \item{ Chugoku }{ 中国ブロックの得票数; numeric }
#'   \item{ Shikoku }{ 四国ブロックの得票数; numeric }
#'   \item{ Kyushu }{ 九州ブロックの得票数; numeric }
#' }
#' 
#' @usage data(jp_lower_2017)
#' 
#' @source 総務省
"jp_lower_2017"
```

```{r function-jp_lower_2021}
#' 衆議院議員総選挙比例区得票数 (2021年)
#'
#' 衆議院議員総選挙比例区の得票数 (2021年)
#'
#' @format A data frame with 47 rows and 12 variables:
#' \describe{
#'   \item{ Party }{ 政党名; character }
#'   \item{ Hokkaido }{ 北海道ブロックの得票数; numeric }
#'   \item{ Tohoku }{ 東北ブロックの得票数; numeric }
#'   \item{ Kitakanto }{ 北関東ブロックの得票数; numeric }
#'   \item{ Minamikanto }{ 南関東ブロックの得票数; numeric }
#'   \item{ Tokyo }{ 東京ブロックの得票数; numeric }
#'   \item{ Hokuriku }{ 北陸信越ブロックの得票数; numeric }
#'   \item{ Tokai }{ 東海ブロックの得票数; numeric }
#'   \item{ Kinki }{ 近畿ブロックの得票数; numeric }
#'   \item{ Chugoku }{ 中国ブロックの得票数; numeric }
#'   \item{ Shikoku }{ 四国ブロックの得票数; numeric }
#'   \item{ Kyushu }{ 九州ブロックの得票数; numeric }
#' }
#' 
#' @usage data(jp_lower_2021)
#' 
#' @source 総務省
"jp_lower_2021"
```

```{r function-jp_upper_2019}
#' 参議院議員通常選挙比例区得票数 (2019年)
#'
#' 参議院議員通常選挙比例区の得票数 (2019年)
#'
#' @format A data frame with 47 rows and 2 variables:
#' \describe{
#'   \item{ Party }{ 政党名; character }
#'   \item{ Vote }{ 各政党の得票数; numeric }
#' }
#' 
#' @usage data(jp_upper_2019)
#' 
#' @source 総務省
"jp_upper_2019"
```

```{r function-kr_lower_2004}
#' 韓国国会議員総選挙比例区得票数 (2004年)
#'
#' 韓国国会議員総選挙比例区の得票数 (2004年)
#'
#' @format A data frame with 47 rows and 2 variables:
#' \describe{
#'   \item{ Party }{ 政党名; character }
#'   \item{ Vote }{ 各政党の得票数; numeric }
#' }
#' 
#' @usage data(kr_lower_2004)
#' 
#' @source 韓国中央選挙管理委員会
"kr_lower_2004"
```

```{r function-kr_lower_2008}
#' 韓国国会議員総選挙比例区得票数 (2008年)
#'
#' 韓国国会議員総選挙比例区の得票数 (2008年)
#'
#' @format A data frame with 47 rows and 2 variables:
#' \describe{
#'   \item{ Party }{ 政党名; character }
#'   \item{ Vote }{ 各政党の得票数; numeric }
#' }
#' 
#' @usage data(kr_lower_2008)
#' 
#' @source 韓国中央選挙管理委員会
"kr_lower_2008"
```

```{r function-kr_lower_2012}
#' 韓国国会議員総選挙比例区得票数 (2012年)
#'
#' 韓国国会議員総選挙比例区の得票数 (2012年)
#'
#' @format A data frame with 47 rows and 2 variables:
#' \describe{
#'   \item{ Party }{ 政党名; character }
#'   \item{ Vote }{ 各政党の得票数; numeric }
#' }
#' 
#' @usage data(kr_lower_2012)
#' 
#' @source 韓国中央選挙管理委員会
"kr_lower_2012"
```

```{r function-kr_lower_2016}
#' 韓国国会議員総選挙比例区得票数 (2016年)
#'
#' 韓国国会議員総選挙比例区の得票数 (2016年)
#'
#' @format A data frame with 47 rows and 2 variables:
#' \describe{
#'   \item{ Party }{ 政党名; character }
#'   \item{ Vote }{ 各政党の得票数; numeric }
#' }
#' 
#' @usage data(kr_lower_2016)
#' 
#' @source 韓国中央選挙管理委員会
"kr_lower_2016"
```

```{r function-us_census_2020}
#' アメリカ州別人口 (2020年)
#'
#' アメリカ州別人口 (2020年)
#'
#' @format A data frame with 47 rows and 2 variables:
#' \describe{
#'   \item{ State }{ 州名; character }
#'   \item{ Pop }{ 人口; numeric }
#' }
#' 
#' @usage data(us_census_2020)
#' 
#' @source U.S. Census Bureau
"us_census_2020"
```

サンプルデータは以下の通りです。

| データ名 | 説明 | 国 |
|:---------|:-----|:---|
|`jp_census_1920`|都道府県別人口 (1920年)|日本|
|`jp_census_1945`|都道府県別人口 (1945年)|日本|
|`jp_census_1970`|都道府県別人口 (1970年)|日本|
|`jp_census_2015`|都道府県別人口 (2015年)|日本|
|`jp_lower_2009`|衆議院議員総選挙比例区得票数 (2009年)|日本|
|`jp_lower_2012`|衆議院議員総選挙比例区得票数 (2012年)|日本|
|`jp_lower_2014`|衆議院議員総選挙比例区得票数 (2014年)|日本|
|`jp_lower_2017`|衆議院議員総選挙比例区得票数 (2017年)|日本|
|`jp_lower_2021`|衆議院議員総選挙比例区得票数 (2021年)|日本|
|`jp_upper_2019`|参議院議員通常選挙比例区得票数 (2021年)|日本|
|`kr_lower_2004`|韓国国会議員総選挙比例区得票数 (2004年)|韓国|
|`kr_lower_2006`|韓国国会議員総選挙比例区得票数 (2008年)|韓国|
|`kr_lower_2012`|韓国国会議員総選挙比例区得票数 (2012年)|韓国|
|`kr_lower_2016`|韓国国会議員総選挙比例区得票数 (2016年)|韓国|
|`us_census_2020`|アメリカ州別人口 (2020年)|アメリカ|

```{r examples-data-1}
#| dev: "ragg_png"
#| fig.width: 10
#| fig.height: 7
#| out.width: 700
#| dpi: 300
data(jp_census_1920)

head(jp_census_1920)
tail(jp_census_1920)

PR_sample1 <- PRcalc(jp_census_1920, seats = 250, method = "dt")
PR_sample1
index(PR_sample1)
plot(PR_sample1, 
     xlab = "都道府県", vs_lab = "人口割合", ss_lab = "割当議席率",
     text_angle = 45)
```

```{r examples-data-2}
data(jp_census_2015)

PR_sample2 <- PRcalc(jp_census_2015, seats = 250, method = "adams")
PR_sample3 <- PRcalc(jp_census_2015, seats = 250, method = "dt")

compare(PR_sample2, PR_sample3)

compare(PR_sample2, PR_sample3, type = "index")
```

```{r examples-data-3}
#| dev: "ragg_png"
#| fig.width: 10
#| fig.height: 7
#| out.width: 700
#| dpi: 300
data(jp_lower_2021)

PR_sample4 <- PRcalc(jp_lower_2021, method = "hare",
                     seats = c(8, 14, 20, 21, 17, 11, 21, 30, 11, 6, 21))

summary(PR_sample4)
plot(PR_sample4, text_angle = 90)
```

```{r examples-data-4}
#| dev: "ragg_png"
#| fig.width: 10
#| fig.height: 7
#| out.width: 700
#| dpi: 300
data(kr_lower_2016)

PR_sample5 <- PRcalc(kr_lower_2016, method = "hare", seats = 47)
PR_sample6 <- PRcalc(kr_lower_2016, method = "hare", seats = 47, 
                     threshold = 0.05)

compare(PR_sample5, PR_sample6)
plot(PR_sample6, 
     xlab = "정당명", vs_lab = "득표율", ss_lab = "의석비율",
     text_size = 16)
```

```{r development-inflate, eval = FALSE}
fusen::inflate(
  flat_file     = "dev/flat_full.Rmd",
  vignette_name = "Get started",
  open_vignette = FALSE,
  check         = TRUE,
  overwrite     = "yes"
  )
#remotes::install_local(force = TRUE)
```
